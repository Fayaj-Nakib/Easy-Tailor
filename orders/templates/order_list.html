{% extends 'base.html' %}
{% block content %}
{% if is_tailor %}
<h2 class="mb-4">All Orders</h2>
<table class="table table-hover table-striped align-middle">
  <thead class="table-dark">
    <tr>
      <th>SL</th>
      <th>Customer</th>
      <th>Items</th>
      <th>Order Discount</th>
      <th>Total Price</th>
      <th>Payment</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for order in orders %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ order.customer.get_full_name|default:order.customer.username }}</td>
      <td>
        <button class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#items{{ order.id }}" aria-expanded="false" aria-controls="items{{ order.id }}">Details</button>
        <div class="collapse mt-2" id="items{{ order.id }}">
          <ul class="list-group">
          {% for it in order.items.all %}
            <li class="list-group-item small">
              <strong>{{ it.service.name }}</strong> ({{ it.service_type }}, {{ it.gender|title }}, qty: {{ it.quantity }},
              {% if it.measurement_type == 'regular' %}Size {{ it.regular_size }}{% else %}{{ it.custom_measurements }}{% endif %})
              <span class="text-secondary ms-2">${{ it.line_total|floatformat:2 }}</span>
            </li>
          {% endfor %}
          </ul>
          {% if order.design_preference %}
            <div class="alert alert-secondary mt-2 py-2 px-3 small"> <strong>Design Pref:</strong> {{ order.design_preference }} </div>
          {% endif %}
        </div>
      </td>
      <td>${{ order.discount|floatformat:2 }}</td>
      <td><strong>${{ order.total_price|floatformat:2 }}</strong></td>
      <td>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="order_id" value="{{ order.id }}">
          <button class="btn btn-sm {% if order.payment_status == 'Paid' %}btn-success{% else %}btn-outline-secondary{% endif %}" name="toggle_payment" value="1" {% if order.payment_status == 'Paid' %}disabled{% endif %}>
            {{ order.payment_status }}
          </button>
        </form>
      </td>
      <td>{{ order.status }}</td>
      <td>
        <form method="post" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="order_id" value="{{ order.id }}">
          {% if order.status == 'Pending' %}
            <input type="number" step="0.01" class="form-control d-inline w-auto me-1" name="discount" placeholder="Discount">
            <button name="confirm" value="1" class="btn btn-sm btn-success">Confirm</button>
          {% else %}
            <button class="btn btn-sm btn-secondary" disabled>{{ order.status }}</button>
          {% endif %}
        </form>
        <form method="post" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="order_id" value="{{ order.id }}">
          <button name="deny" value="1" class="btn btn-sm btn-warning" {% if order.status != 'Pending' %}disabled{% endif %}>Deny</button>
        </form>
        <form method="post" class="d-inline">
          {% csrf_token %}
          <input type="hidden" name="order_id" value="{{ order.id }}">
          <button name="cancel" value="1" class="btn btn-sm btn-danger {% if order.payment_status == 'Paid' %}opacity-50{% endif %}" {% if order.status == 'Cancelled' or order.payment_status == 'Paid' %}disabled{% endif %}>Cancel</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<h2 class="mb-4">My Orders</h2>
<table class="table table-hover table-striped align-middle">
  <thead class="table-dark">
    <tr>
      <th>Order #</th>
      <th>Date</th>
      <th>Tailor</th>
      <th>Status</th>
      <th>Total Price</th>
      <th>Items</th>
      <th>Payment Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
  {% for order in orders %}
    <tr>
      <td>{{ order.id }}</td>
      <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
      <td>{% if order.tailor %}{{ order.tailor.shop_name|default:order.tailor.username|default:'-' }}{% else %}-{% endif %}</td>
      <td>{{ order.status }}</td>
      <td><strong>${{ order.total_price|floatformat:2 }}</strong>{% if order.discount %} <span class="badge bg-success">- ${{ order.discount|floatformat:2 }}</span>{% endif %}</td>
      <td>
        <button class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#items{{ order.id }}" aria-expanded="false" aria-controls="items{{ order.id }}">View</button>
        <div class="collapse mt-2" id="items{{ order.id }}">
          <ul class="list-group">
          {% for it in order.items.all %}
            <li class="list-group-item small">
              <strong>{{ it.service.name }}</strong> ({{ it.service_type }}, {{ it.gender|title }}, qty: {{ it.quantity }}, {% if it.measurement_type == 'regular' %}Size {{ it.regular_size }}{% else %}{{ it.custom_measurements }}{% endif %})
              <span class="text-secondary ms-2">${{ it.line_total|floatformat:2 }}</span>
            </li>
          {% endfor %}
          </ul>
        </div>
      </td>
      <td>{{ order.payment_status }}</td>
      <td>
        {% if order.status == "Pending" %}
        <form method="post" action="{% url 'order_detail' order.id %}" class="d-inline">
          {% csrf_token %}
          <button name="cancel" value="1" class="btn btn-sm btn-danger">Cancel</button>
        </form>
        {% else %}
        <span class="text-secondary">-</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% endif %}
{% endblock %}
